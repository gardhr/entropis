<!--  (Note: This page can be saved and used offline.) -->
<!DOCTYPE html>
<html>
  <head>
    <title>Entropis Password Manager</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      #critique-toggle {
        color: #000bd6;
        width: 75%;
        background-color: #d60000;
      }
      #critique-gauge {
        width: 0%;
        height: 30px;
        background-color: #0bd600;
      }
    </style>
    <script src="entropis.js"></script>
    <script>
      var visible = false;

      function curry(data, action) {
        return function () {
          return action(data);
        };
      }

      function strict_password_entropy(password) {
        var length = password.length;
        if (length == 0) return 0;
        var present = new Array(256);
        for (var index = 0; index < password.length; ++index)
          present[password.codePointAt(index)] = true;
        var unique = 0;
        for (var index = 0; index < 256; ++index) if (present[index]) ++unique;
        return Math.floor((length * Math.log(unique)) / Math.log(2));
      }

      function element(id) {
        return document.getElementById(id);
      }

      function reset_html(id, text) {
        element(id).innerHTML = text || "";
      }

      function reset_input(id, text) {
        element(id).value = text || "";
      }

      function value(id) {
        return element(id).value;
      }

      function create(tag, options) {
        return document.createElement(tag, options);
      }

      function error(message) {
        return reset_html("errors", "Error: " + message);
      }

      function status(message) {
        reset_html("status", message || "");
      }

      function show_element(that, yes) {
        (element(that) || that).style.display =
          yes !== false ? "block" : "none";
      }

      function hide_element(that) {
        show_element(that, false);
      }

      function rebuild(passwords) {
        status(null);
        reset_html("errors");
        reset_html("listing");
        reset_input("domain");
        reset_input("password");
        try {
          localStorage.setItem("entropis", entropis.storage);
        } catch (exception) {
          return error("Browser local storage is full and/or unavailable");
        }
        var listing = element("listing");
        if (passwords == null) {
          var passphrase = value("passphrase");
          if (passphrase === "") {
            if (entropis.storage == null)
              return status("Please set your new master passphrase");
            return status("Please enter your master passphrase");
          }
          passwords = entropis.get(passphrase);
          if (passwords == null) return error("Incorrect master password");
        }
        if (Object.keys(passwords).length == 0)
          return status("Password list is empty");
        for (var domain in passwords) {
          var row = create("tr");
          listing.appendChild(row);
          var td1 = create("td");
          row.appendChild(td1);
          var bcd = create("button");
          bcd.innerText = "ðŸ“‹";
          bcd.title = "Copy domain to clipboard";
          bcd.addEventListener(
            "click",
            curry(domain, (domain) => {
              copy(domain);
              reset_input("domain", domain);
            })
          );
          td1.appendChild(bcd);
          var inp1 = create("input");
          var color = "#D3D3D3";
          inp1.readOnly = true;
          inp1.value = domain;
          inp1.style.backgroundColor = color;
          inp1.onfocus = curry(inp1, (that) => {
            that.select();
            reset_input("domain", that.value);
          });
          td1.appendChild(inp1);
          var td2 = create("td");
          row.appendChild(td2);
          var bcp = create("button");
          bcp.innerText = "ðŸ“‹";
          bcp.title = "Copy password to clipboard";
          var password = passwords[domain];
          bcp.addEventListener(
            "click",
            curry(password, (password) => {
              copy(password);
              reset_input("password", password);
            })
          );
          td2.appendChild(bcp);
          var inp2 = create("input");
          if (visible) inp2.type = "text";
          else inp2.type = "password";
          inp2.readOnly = true;
          inp2.value = password;
          inp2.style.backgroundColor = color;
          inp2.onfocus = curry(inp2, (that) => {
            that.select();
            reset_input("password", that.value);
          });
          td2.appendChild(inp2);
          var b1 = create("button");
          b1.innerText = "delete";
          b1.title = "Delete this entry from the datastore";
          b1.addEventListener(
            "click",
            curry(domain, (domain) => {
              if (
                !confirm(
                  "Warning: THIS ACTION WILL PERMANANTLY DELETE `" +
                    domain +
                    "` FROM THE PASSWORD DATABASE!!!"
                )
              )
                return;
              remove(domain);
            })
          );
          td2.appendChild(b1);
        }
        show_element("specials-toggle");
      }

      function hide_utils() {
        hide_element("import-toggle");
        hide_element("merge-toggle");
        hide_element("export-toggle");
        hide_element("change-toggle");
        hide_element("critique-toggle");
      }

      function refresh(passwords) {
        hide_utils();
        return rebuild(passwords);
      }

      function hide_specials() {
        hide_utils();
        //TODO:
        //hide_element("specials-toggle");
      }

      function lock() {
        reset_input("passphrase");
        refresh();
      }

      function toggle() {
        var passphrase = element("passphrase");
        var newpass = element("newpass");
        var oldpass = element("oldpass");
        var password = element("password");
        var visibility = element("visibility");
        visible = !visible;
        if (visible) {
          passphrase.type = "text";
          newpass.type = "text";
          oldpass.type = "text";
          password.type = "text";
          visibility.value = "hide";
        } else {
          passphrase.type = "password";
          newpass.type = "password";
          oldpass.type = "password";
          password.type = "password";
          visibility.value = "show";
        }
        rebuild();
      }

      function update() {
        var passphrase = value("passphrase");
        var passwords = entropis.get(passphrase);
        if (passwords == null)
          return error("Cannot update (incorrect master password)");
        var domain = value("domain").trim();
        if (domain === "") return error("Domain cannot be empty");
        var password = value("password");
        var trimmed = password.trim();
        if (password != trimmed) {
          if (
            confirm(
              "Warning: password contains leading/trailing spaces.\n" +
                "Click 'Cancel' to leave as is, or 'OK' to remove these extra spaces."
            )
          )
            password = trimmed;
        }
        if (password === "") {
          if (!confirm("Warning: password is empty.")) return;
        }
        entropis.set(passphrase, domain, password);
        passwords[domain] = password;
        refresh(passwords);
      }

      function remove(domain) {
        if (!entropis.remove(value("passphrase"), domain))
          return error("Cannot remove entry (incorrect master password)");
        refresh();
      }

      function copy(text) {
        try {
          navigator.clipboard.writeText(text);
          status("Data copied to clipboard");
        } catch (ignore) {}
      }

      function lookup() {
        var passwords = entropis.get(value("passphrase"));
        if (passwords == null)
          return error("Cannot search (incorrect master password)");
        var pattern = value("search").trim().toLowerCase();
        var found = {};
        for (var domain in passwords) {
          if (domain.toLowerCase().indexOf(pattern) != -1)
            found[domain] = passwords[domain];
        }
        refresh(found);
        var count = Object.keys(found).length;
        var suffix = count == 1 ? "" : "es";
        status(count + " match" + suffix + " found");
      }

      function drop() {
        if (
          !confirm(
            "Warning: THIS ACTION WILL PERMANANTLY DELETE THE CURRENT PASSWORD DATABASE!!!\n"
          )
        )
          return;
        entropis.storage = null;
        refresh();
      }

      function initiate_import() {
        hide_specials();
        if (
          !confirm(
            "Warning: THIS ACTION WILL PERMANANTLY REPLACE THE CURRENT PASSWORD DATABASE!!!\n"
          )
        )
          return;
        try {
          var input = navigator.clipboard.readText();
          if (!input) return error("Clipboard is empty/inaccessible");
          entropis.storage = input;
          status("Password database copied from clipboard");
        } catch (ignore) {}
        show_element("import-toggle");
      }

      function initiate_merge() {
        hide_specials();
        if (
          !confirm(
            "Warning: THIS ACTION WILL PERMANANTLY ALTER THE CURRENT PASSWORD DATABASE!!!\n"
          )
        )
          return;
        try {
          var input = navigator.clipboard.readText();
          if (!input) return error("Clipboard is empty/inaccessible");
          status("Old database copied from clipboard");
        } catch (ignore) {}
        show_element("merge-toggle");
      }

      function do_import() {
        var input = element("import").value;
        if (!input) return error("Nothing to import");
        entropis.storage = input;
        refresh();
      }

      function do_merge() {
        refresh();
        var input = element("merge").value;
        if (!input) return error("Nothing to import");
        var passphrase = value("passphrase");
        var oldpass = value("oldpass");
        if (!oldpass || oldpass === "") oldpass = passphrase;
        var force = element("force-merge").checked;
        if (!entropis.merge(passphrase, input, oldpass, force))
          return error(
            "Cannot merge due to merge conflict and/or incorrect set of passwords provided)"
          );
        reset_input("oldpass");
        refresh();
      }

      function do_export() {
        refresh();
        if (!entropis.get(value("passphrase")))
          return error("Cannot export (incorrect master password)");
        if (!entropis.storage) return error("Nothing to export");
        copy(entropis.storage);
        reset_input("export", entropis.storage);
        show_element("export-toggle");
        element("export").select();
      }

      function initiate_change() {
        hide_specials();
        show_element("change-toggle");
        element("newpass").select();
      }

      function change() {
        var newpass = element("newpass").value;
        var trimmed = newpass.trim();
        if (newpass != trimmed) {
          if (
            confirm(
              "Warning: password contains leading/trailing spaces.\n" +
                "Click 'Cancel' to leave as is, or 'OK' to remove these extra spaces."
            )
          )
            newpass = trimmed;
        }
        if (newpass === "") {
          if (!confirm("Warning: password is empty.")) return;
        }
        if (!entropis.change(value("passphrase"), newpass))
          return error("Cannot change password (incorrect master password)");
        reset_input("passphrase", newpass);
        reset_input("newpass");
        refresh();
      }

      var criteria = 175;

      function critique(keyboard) {
        if (keyboard.code == "Enter") return change();
        var progress = element("critique-toggle");
        var newpass = value("newpass");
        if (newpass === "") return hide_element(progress);
        show_element(progress);
        var entropy = strict_password_entropy(newpass);
        var ratio = entropy / criteria;
        if (ratio >= 1) ratio = 1;
        element("critique-gauge").style.width = Math.floor(ratio * 100) + "%";
        var ratings = ["weak", "poor", "fair", "good", "excellent"];
        var index = Math.floor(ratio * ratings.length);
        if (index == ratings.length) --index;
        var score = ratings[index];
        reset_html("critique-gauge", "&nbsp" + score);
      }

      function initialize() {
        entropis.storage = localStorage.getItem("entropis");
        element("newpass").addEventListener("keydown", critique);
        element("export").addEventListener("keydown", function (keyboard) {
          if (keyboard.code == "Enter") hide_element("export-toggle");
        });
        element("force-merge").checked = false;
        refresh();
        hide_specials();
      }
    </script>
  </head>
  <body
    style="
      background-color: #d9ecec;
      color: #369;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 20px;
      font-weight: bold;
    "
    onload="initialize()"
  >
    <div align="left">
      <a href="https://github.com/gardhr/entropis">GitHub</a>
    </div>
    <h2 align="center">Entropis Password Manager</h2>
    <div align="center">(Note: This page can be saved and used offline.)</div>
    <br />
    <br /><br />
    <form onsubmit="refresh()" action="javascript:void(0)">
      <table align="center">
        <tr>
          <td>
            <input
              type="button"
              id="visibility"
              value="show"
              onclick="toggle()"
              title="Show/hide all password fields"
            />
            <input
              type="button"
              value="drop"
              onclick="drop()"
              title="Delete the current datastore"
            />
            <input
              type="button"
              value="import ðŸ“‹"
              onclick="initiate_import()"
              title="Import base64-encoded datastore"
            />
            <input
              type="button"
              value="merge ðŸ“‹"
              onclick="initiate_merge()"
              title="Merge a base64-encoded datastore with this one"
            />
            <input
              type="button"
              value="export ðŸ“‹"
              onclick="do_export()"
              title="Export the current datastore"
            />
            <input
              type="button"
              value="change"
              onclick="initiate_change()"
              title="Change password"
            />
          </td>
        </tr>
        <tr>
          <td>
            Master Passphrase &nbsp;<input
              type="password"
              id="passphrase"
              onfocus="this.select()"
            />
            <input
              type="submit"
              value="unlock"
              title="Log in to the current datastore"
            />
            <input
              type="submit"
              value="lock"
              title="Log out of the current datastore"
              onclick="lock()"
            />
          </td>
        </tr>
        <tr>
          <td>
            <div hidden width="100%" id="import-toggle" align="center">
              Import
              <textarea
                id="import"
                onfocus="this.value = '', this.select()"
              ></textarea>
              <input type="button" value="submit" onclick="do_import()" />
              <input
                type="button"
                value="cancel"
                onclick="hide_element('import-toggle')"
              />
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <div hidden width="100%" id="export-toggle" align="center">
              Export <textarea id="export" onfocus="this.select()"></textarea>
              <input
                type="button"
                value="dismiss"
                onclick="hide_element('export-toggle')"
              />
            </div>
          </td>
        </tr>
        <tbody hidden width="100%" id="change-toggle">
          <tr>
            <td>
              New Passphrase &nbsp;<input
                type="password"
                id="newpass"
                onfocus="this.select()"
              />
              <input type="button" value="submit" onclick="change()" />
              <input
                type="button"
                value="cancel"
                onclick="hide_element('change-toggle')"
              />
            </td>
          </tr>
          <tr>
            <td>
              <div width="100%" id="critique-toggle">
                <div id="critique-gauge"></div>
              </div>
            </td>
          </tr>
        </tbody>
        <tbody width="100%" id="merge-toggle" align="center">
          <tr>
            <td>
              Old password (if applicable) &nbsp;<input
                type="password"
                id="oldpass"
                onfocus="this.select()"
              />
            </td>
          </tr>
          <tr>
            <td>
              Merge with
              <textarea
                id="merge"
                onfocus="this.value = '', this.select()"
              ></textarea>
              <input type="button" value="submit" onclick="do_merge()" />
              <input
                type="button"
                value="cancel"
                onclick="hide_element('merge-toggle')"
              />
            </td>
          </tr>
          <tr>
            <td>
              <input type="checkbox" id="force-merge" />
              <label for="force-merge">Overwrite duplicate entries?</label>
            </td>
          </tr>
        </tbody>
      </table>
    </form>
    <div id="specials-toggle" align="center">
      <form onsubmit="lookup()" action="javascript:void(0)">
        <table align="center" style="">
          <tr>
            <td>
              <input type="text" id="search" onfocus="this.select()" />
              <button title="Find a domain in the datastore">search</button>
            </td>
          </tr>
        </table>
      </form>
      <form onsubmit="update()" action="javascript:void(0)">
        <table align="center">
          <tr>
            <td>Domain</td>
            <td>Password</td>
          </tr>
          <tr>
            <td>
              <input type="text" id="domain" onfocus="this.select()" />
            </td>
            <td>
              <input type="password" id="password" onfocus="this.select()" />
            </td>
            <td>
              <button title="Update domain/password pair in the datastore">
                add/update
              </button>
            </td>
          </tr>
        </table>
      </form>
    </div>
    <p id="status" align="center" style="color: #50366d"></p>
    <table id="listing" align="center" style=""></table>
    <p id="errors" align="center" style="color: #d60000"></p>
  </body>
</html>
