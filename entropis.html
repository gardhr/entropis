<!DOCTYPE html>
<html>
  <head>
    <title>Entropis Password Manager</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      #progress {
        color: black;
        width: 100%;
        background-color: red;
      }
      #bar {
        width: 0%;
        height: 30px;
        background-color: green;
      }
    </style>
    <script src="entropis.js"></script>
    <script>
      entropis.storage = localStorage.getItem("entropis");
      var visible = false;

      function element(id) {
        return document.getElementById(id);
      }

      function reset_html(id, text) {
        element(id).innerHTML = text || "";
      }

      function reset_input(id, text) {
        element(id).value = text || "";
      }

      function value(id) {
        return element(id).value;
      }

      function create(tag, options) {
        return document.createElement(tag, options);
      }

      function error(message) {
        return reset_html("errors", "Error: " + message);
      }

      function status(message) {
        reset_html("status", message || "");
      }

      function refresh(passwords) {
        status(null);
        reset_html("errors");
        reset_input("domain");
        reset_input("password");
        reset_html("listing");
        try {
          localStorage.setItem("entropis", entropis.storage);
        } catch (exception) {
          return error("Browser local storage is full and/or unavailable");
        }
        var listing = element("listing");
        if (passwords == null) {
          passwords = entropis.get(value("passphrase"));
          if (passwords == null) return error("Incorrect master password");
        }
        if (Object.keys(passwords).length == 0)
          return status("Password list is empty");
        for (var domain in passwords) {
          var row = create("tr");
          listing.appendChild(row);
          var td1 = create("td");
          row.appendChild(td1);
          var inp1 = create("input");
          var color = "#D3D3D3";
          inp1.readOnly = true;
          inp1.value = domain;
          inp1.style.backgroundColor = color;
          inp1.onFocus = "this.select()";
          td1.appendChild(inp1);
          var td2 = create("td");
          row.appendChild(td2);
          var inp2 = create("input");
          if (visible) inp2.type = "text";
          else inp2.type = "password";
          inp2.readOnly = true;
          inp2.value = passwords[domain];
          inp2.style.backgroundColor = color;
          inp2.onFocus = "this.select()";
          td2.appendChild(inp2);
          var b1 = create("button");
          b1.innerText = "delete";
          b1.addEventListener("click", () => {
            remove(domain);
          });
          td2.appendChild(b1);
        }
      }

      function toggle() {
        var passphrase = element("passphrase");
        var password = element("password");
        var visibility = element("visibility");
        visible = !visible;
        if (visible) {
          passphrase.type = "text";
          password.type = "text";
          visibility.value = "hide";
        } else {
          passphrase.type = "password";
          password.type = "password";
          visibility.value = "show";
        }
        refresh();
      }

      function update() {
        var passphrase = value("passphrase");
        var passwords = entropis.get(passphrase);
        if (passwords == null)
          return error("Cannot update (incorrect master password)");
        var domain = value("domain").trim();
        if (domain == "") return error("Domain cannot be empty");
        var password = value("password");
        var trimmed = password.trim();
        if (password != trimmed) {
          if (
            confirm(
              "Warning: password contains leading/trailing spaces.\n" +
                "Click 'Cancel' to leave as is, or 'OK' to remove these extra spaces."
            )
          )
            password = trimmed;
        }
        if (password == "") {
          if (!confirm("Warning: password is empty.")) return;
        }
        entropis.set(passphrase, domain, password);
        passwords[domain] = password;
        refresh(passwords);
      }

      function remove(domain) {
        if (!entropis.remove(value("passphrase"), domain))
          return error("Cannot remove entry (incorrect master password)");
        refresh();
      }

      function lookup() {
        var passwords = entropis.get(value("passphrase"));
        if (passwords == null)
          return error("Cannot search (incorrect master password)");
        var pattern = value("search").trim().toLowerCase();
        var found = {};
        for (var domain in passwords) {
          if (domain.toLowerCase().indexOf(pattern) != -1)
            found[domain] = passwords[domain];
        }
        refresh(found);
        var count = Object.keys(found).length;
        var suffix = count == 1 ? "" : "es";
        status(count + " match" + suffix + " found");
      }

      function drop() {
        if (
          confirm(
            "Warning: THIS ACTION WILL PERMANANTLY DELETE THE CURRENT PASSWORD DATABASE!!!\n"
          )
        )
          entropis.storage = null;
        refresh();
      }

      function strict_password_entropy(password) {
        var length = password.length;
        if (length == 0) return 0;
        var present = new Array(256);
        for (var index = 0; index < password.length; ++index)
          present[password.codePointAt(index)] = true;
        var unique = 0;
        for (var index = 0; index < 256; ++index) if (present[index]) ++unique;
        return Math.floor((length * Math.log(unique)) / Math.log(2));
      }

      var criteria = 100;

      function critique() {
        var progress = element("progress");
        var passphrase = value("passphrase");
        if (passphrase == "") {
          progress.style.display = "none";
          return status("Please enter your master passphrase");
        }
        progress.style.display = "block";
        var entropy = strict_password_entropy(passphrase);
        var ratio = entropy / criteria;
        if (ratio >= 1) ratio = 1;
        element("bar").style.width = Math.floor(ratio * 100) + "%";
        var ratings = ["weak", "poor", "fair", "good", "excellent"];
        var index = Math.floor(ratio * ratings.length);
        if (index == ratings.length) --index;
        var score = ratings[index];
        reset_html("bar", "&nbsp" + score);
      }
    </script>
  </head>
  <body
    style="
      background-color: #ccfcd1;
      color: #369;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 20px;
      font-weight: bold;
    "
    onload="element('passphrase').addEventListener('keyup', critique), critique()"
  >
    <div align="left">
      <a href="https://github.com/gardhr/entropis">GitHub</a>
    </div>
    <div align="center">(Note: This page can be saved and used offline.)</div>
    <br />
    <h2 align="center">Entropis Password Manager</h2>
    <br />
    <form onsubmit="refresh()" action="javascript:void(0)">
      <table align="center" style="">
        <tr>
          <td>
            Master Passphrase &nbsp;
            <input
              type="button"
              id="visibility"
              value="show"
              onclick="toggle()"
            />
            <input type="button" value="drop" onclick="drop()" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="password" id="passphrase" onfocus="this.select()" />
            <input type="submit" value="unlock" />
          </td>
        </tr>
        <tr>
          <td>
            <div id="progress">
              <div id="bar"></div>
            </div>
          </td>
        </tr>
      </table>
    </form>
    <form onsubmit="lookup()" action="javascript:void(0)">
      <table align="center" style="">
        <tr>
          <td>
            <input type="text" id="search" onfocus="this.select()" />
            <button>search</button>
          </td>
        </tr>
      </table>
    </form>
    <form onsubmit="update()" action="javascript:void(0)">
      <table align="center" style="">
        <tr>
          <td>Domain</td>
          <td>Password</td>
        </tr>
        <tr>
          <td>
            <input type="text" id="domain" onfocus="this.select()" />
          </td>
          <td>
            <input type="password" id="password" onfocus="this.select()" />
          </td>
          <td><button>add/update</button></td>
        </tr>
      </table>
    </form>
    <p id="status" align="center" style="color: #50366d; word-wrap: break-word"></p>
    <form onsubmit="" action="javascript:void(0)">
      <table id="listing" align="center" style=""></table>
    </form>

    <p id="errors" align="center" style="color: red"></p>
  </body>
</html>
